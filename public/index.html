<!-- seditor , mongoeditor -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>C++ 控制 Canvas</title>
  <style>
    textarea { width: 100%; height: 200px; font-family: monospace; }
    canvas { border: 1px solid black; margin-top: 10px; }
    pre { background: #f0f0f0; padding: 1em; }
  </style>
</head>
<body>
  <select id="theme-select" style="margin-bottom: 10px;">
    <option value="vs"selected>vs</option>
    <option value="vs-dark">vs-dark</option>
    <option value="hc-black">hc-black</option>
    <option value="hc-light">hc-light</option>
  </select>
  <div id="code" style="width: 800px; height: 600px; border: 1px solid grey"></div>
  <h1>C++ 控制 Canvas 畫圖</h1>
  <button onclick="runCode()">執行</button>
  <h3>輸出：</h3>
  <pre id="output"></pre>

  <div id="canvas-container" style="width: 400px; height: 300px; border: 1px solid black;"></div>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script>
  
  // 初始化 Konva 畫布
  const stage = new Konva.Stage({
    container: 'canvas-container',
    width: 400,
    height: 300,
  });
  const layer = new Konva.Layer();
  stage.add(layer);
  // 放在 <script> 區塊裡，layer 宣告完之後即可加
  function expandStageIfNeeded(padding = 20) {
    const rect = layer.getClientRect({ skipTransform: true });

    const needW = Math.ceil(rect.x + rect.width + padding);
    const needH = Math.ceil(rect.y + rect.height + padding);

    if (needW > stage.width() || needH > stage.height()) {
      stage.width(needW);
      stage.height(needH);

      const container = document.getElementById('canvas-container');
      container.style.width = needW + 'px';
      container.style.height = needH + 'px';

      stage.draw(); // 重繪
    }
  }
  const centerX = stage.width() / 2;
  const centerY = stage.height() / 2;
  let number = 0;

  // 改寫的 drawCircle：保持和 C++ 輸出格式一致
  const circles = [];
  function drawCircle(x, y, r, message = "") {
    const fixX = centerX + x;
    const fixY = centerY + y;

    const circle = new Konva.Circle({
      x: fixX,
      y: fixY,
      radius: r,
      fill: 'skyblue',
      stroke: 'black',
      strokeWidth: 1
    });

    const label = new Konva.Text({
      x: fixX - r,
      y: fixY - r / 2,
      width: r * 2,
      height: r,
      text: message,
      fontSize: Math.max(r * 0.8, 10),
      fontFamily: 'Arial',
      align: 'center',
      verticalAlign: 'middle',
      fill: 'black'
    });

    layer.add(circle);
    layer.add(label);

    layer.draw();
    circles.push(circle); 
    return { circle, label };
  } 
  function drawLineBetweenCircles(c1, c2, strokeWidth = 2) {
    const x1 = c1.x();
    const y1 = c1.y();
    const r1 = c1.radius();
    const x2 = c2.x();
    const y2 = c2.y();
    const r2 = c2.radius();

    const dx = x2 - x1;
    const dy = y2 - y1;
    const dist = Math.sqrt(dx * dx + dy * dy);

    // 避免除以 0
    if (dist === 0) return;

    const ux = dx / dist;
    const uy = dy / dist;

    // 起點在 c1 圓周
    const startX = x1 + ux * r1;
    const startY = y1 + uy * r1;

    // 終點在 c2 圓周
    const endX = x2 - ux * r2;
    const endY = y2 - uy * r2;

    const line = new Konva.Line({
      points: [startX, startY, endX, endY],
      stroke: 'black',
      strokeWidth,
      lineCap: 'round',
      lineJoin: 'round'
    });

    layer.add(line);
    layer.draw();
  }
// 修改 runCode：改為清除 Konva 畫布
  async function runCode() {
    layer.destroyChildren();
    circles.length = 0; // 清空 circles 陣列
    number = 0; // 重置 number
    const code = monaco.editor.getModels()[0].getValue();
    
    const res = await fetch('/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
  
    const data = await res.json();
    document.getElementById('output').textContent = data.output;
  
    try {
      eval(data.output);
      expandStageIfNeeded();  
    } catch (e) {
      alert("JS 錯誤：" + e.message);
    }
  }
  
</script>
    <script src="/monaco/vs/loader.js"></script>
  <script>
    // 如果有多語言設定需求，可以設定 availableLanguages
    require.config({
      paths: { vs: '/monaco/vs' },
      'vs/nls': {
        availableLanguages: {
		      '*': 'zh-tw' // 設定語言為繁體中文
		    }
      }
    });

    require(['vs/editor/editor.main'], async function () {
      const response = await fetch('/default-code'); // 從伺服器載入預設程式碼
      const codeText = await response.text();
      var editor = monaco.editor.create(document.getElementById('code'), {
        value: codeText,
        language: 'cpp',
        automaticLayout: true
      });
      monaco.editor.setTheme('vs'); // 設定主題為暗色
      // 監聽下拉選單切換主題
      const themeSelect = document.getElementById('theme-select');
      themeSelect.addEventListener('change', function() {
        monaco.editor.setTheme(this.value);
      });
    });
  </script>
</body>
</html>
